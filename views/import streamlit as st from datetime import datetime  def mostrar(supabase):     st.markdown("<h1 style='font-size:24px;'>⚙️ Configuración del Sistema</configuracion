import streamlit as st
from datetime import datetime

def mostrar(supabase):
    st.markdown("<h1 style='font-size:24px;'>‚öôÔ∏è Configuraci√≥n del Sistema</h1>", unsafe_allow_html=True)

    # Consultar configuraci√≥n actual
    config_items = supabase.table("configuracion").select("*").execute().data
    config_map = {item["id"]: item for item in config_items}

    # Formulario activo
    formulario_activo = config_map.get("formulario_activo", {}).get("valor", True)
    nuevo_formulario_activo = st.checkbox("‚úÖ Formulario habilitado", value=formulario_activo)

    # Anulaci√≥n activa
    anulacion_activa = config_map.get("anulacion_activa", {}).get("valor", True)
    nueva_anulacion_activa = st.checkbox("‚ùå Permitir anulaci√≥n de evaluaciones", value=anulacion_activa)

    if st.button("üíæ Guardar cambios"):
        usuario = st.session_state.get("usuario", "desconocido")
        ahora = datetime.now().isoformat()

        # Actualizar cada configuraci√≥n si cambi√≥
        if nuevo_formulario_activo != formulario_activo:
            supabase.table("configuracion").upsert({
                "id": "formulario_activo",
                "valor": nuevo_formulario_activo,
                "actualizado_por": usuario,
                "actualizado_en": ahora
            }).execute()

        if nueva_anulacion_activa != anulacion_activa:
            supabase.table("configuracion").upsert({
                "id": "anulacion_activa",
                "valor": nueva_anulacion_activa,
                "actualizado_por": usuario,
                "actualizado_en": ahora
            }).execute()

        st.success("‚úÖ Cambios guardados correctamente.")
